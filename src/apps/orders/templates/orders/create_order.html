{% extends 'base.html' %}
{% load static %}

{% block title %}Создать заказ{% endblock %}

{% block links %}
    <link rel="stylesheet" href="{% static 'css/orders.css' %}">
{% endblock %}

{% block main %}
    <div class="container">
        <div class="order-card">
            <h2 class="center">Создать заказ</h2>

            <form action="{% url 'orders:create' %}" method="POST">
                {% csrf_token %}

                <div class="section">
                    <h4>Детали заказа</h4>
                    <div class="order-details">
                        {{ form.as_p }}
                        {% if form.non_field_errors %}
                            <div class="form-errors">
                                <ul>
                                    {% for error in form.non_field_errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {{ items_formset.management_form }}

                <h4 class="section-title">Блюда</h4>
                <div id="order-items">
                    {% for item_form in items_formset %}
                        <div class="form-row">
                            <div class="row">
                                <div class="half">
                                    {{ item_form.dish.label_tag }}
                                    {{ item_form.dish }}
                                    {% if item_form.dish.errors %}
                                        <ul class="field-errors">
                                            {% for error in item_form.dish.errors %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                                <div class="half">
                                    {{ item_form.price.label_tag }}
                                    {{ item_form.price }}
                                    {% if item_form.price.errors %}
                                        <ul class="field-errors">
                                            {% for error in item_form.price.errors %}
                                                <li>{{ error }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                                <div class="action">
                                    <button type="button" class="remove-item">
                                        Убрать
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div id="empty-form" style="display: none;">
                    <div class="row">
                        <div class="half">
                            {{ items_formset.empty_form.dish.label_tag }}
                            {{ items_formset.empty_form.dish }}
                        </div>
                        <div class="half">
                            {{ items_formset.empty_form.price.label_tag }}
                            {{ items_formset.empty_form.price }}
                        </div>
                        <div class="action">
                            <button type="button" class="remove-item">
                                Убрать
                            </button>
                        </div>
                    </div>
                </div>

                <div class="center section">
                    <button type="button" id="add-item" class="add-item">
                        Добавить блюдо
                    </button>
                    <button type="submit" class="submit-order">Оформить заказ
                    </button>
                </div>
            </form>

            {% if items_formset.non_form_errors %}
                <div class="formset-errors">
                    <ul>
                        {% for error in items_formset.non_form_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}


{% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const formsetContainer = document.getElementById("order-items");
            const addButton = document.getElementById("add-item");
            const totalForms = document.querySelector("[name='form-TOTAL_FORMS']");
            const emptyFormTemplate = document.getElementById("empty-form").innerHTML;

            addButton.addEventListener("click", function () {
                const formCount = parseInt(totalForms.value);
                const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formCount);

                const newFormDiv = document.createElement("div");
                newFormDiv.classList.add("form-row");
                newFormDiv.innerHTML = newFormHtml;

                formsetContainer.appendChild(newFormDiv);
                totalForms.value = formCount + 1;
            });

            formsetContainer.addEventListener("click", function (event) {
                if (event.target.classList.contains("remove-item")) {
                    event.target.closest(".form-row").remove();
                    totalForms.value = formsetContainer.getElementsByClassName("form-row").length;
                }
            });
        });
    </script>
{% endblock %}

